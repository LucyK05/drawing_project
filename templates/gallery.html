<!-- templates/gallery.html -->
{% extends 'base.html' %}

{% block content %}
    <h1>Drawing Gallery</h1>
    <div id="galleryContainer" class="row"></div>

    <script>
        function loadGallery() {
            fetch('/get_drawings')
                .then(res => res.json())
                .then(drawings => {
                    const container = document.getElementById('galleryContainer');
                    container.innerHTML = '';
                    if (drawings.length === 0) {
                        container.innerHTML = '<p>No drawings yet. Go create some!</p>';
                        return;
                    }
                    drawings.forEach((strokes, index) => {
                        const col = document.createElement('div');
                        col.className = 'col-md-6 col-lg-4 mb-4';

                        const card = document.createElement('div');
                        card.className = 'card h-100';

                        const cardBody = document.createElement('div');
                        cardBody.className = 'card-body d-flex flex-column';

                        const title = document.createElement('h5');
                        title.className = 'card-title';
                        title.textContent = `Drawing #${index + 1}`;

                        const canvas = document.createElement('canvas');
                        canvas.width = 400;
                        canvas.height = 300;
                        canvas.style.border = '1px solid #ccc';
                        canvas.style.backgroundColor = 'white';
                        canvas.className = 'mb-3';

                        const ctx = canvas.getContext('2d');
                        strokes.forEach(stroke => {
                            if (stroke.points.length > 0) {
                                ctx.beginPath();
                                ctx.moveTo(stroke.points[0].x * (400 / 800), stroke.points[0].y * (300 / 600));
                                for (let i = 1; i < stroke.points.length; i++) {
                                    ctx.lineTo(stroke.points[i].x * (400 / 800), stroke.points[i].y * (300 / 600));
                                }
                                ctx.strokeStyle = stroke.color;
                                ctx.lineWidth = stroke.thickness * (400 / 800);
                                ctx.lineCap = 'round';
                                ctx.lineJoin = 'round';
                                ctx.stroke();
                            }
                        });

                        const deleteBtn = document.createElement('button');
                        deleteBtn.className = 'btn btn-danger mt-auto';
                        deleteBtn.textContent = 'Delete';
                        deleteBtn.onclick = () => deleteDrawing(index);

                        cardBody.appendChild(title);
                        cardBody.appendChild(canvas);
                        cardBody.appendChild(deleteBtn);

                        card.appendChild(cardBody);
                        col.appendChild(card);
                        container.appendChild(col);
                    });
                });
        }

        function deleteDrawing(index) {
            if (!confirm('Are you sure you want to delete this drawing?')) return;

            fetch(`/delete_drawing/${index}`, {
                method: 'DELETE'
            })
            .then(res => res.json())
            .then(data => {
                if (data.status === 'ok') {
                    alert('Drawing deleted!');
                    loadGallery();
                } else {
                    alert('Error deleting drawing.');
                }
            })
            .catch(err => {
                console.error(err);
                alert('Error deleting drawing.');
            });
        }

        // Load gallery on page load
        loadGallery();
    </script>
{% endblock %}